/**
 * Mﾃｳdulo: Esquema del Formulario de Categorﾃｭas para Filament
 *
 * Este archivo define los campos y secciones que se muestran en el formulario
 * (Create/Edit) del recurso Category dentro del panel de Filament.
 * Incluye validaciones, interacciones dinﾃ｡micas y configuraciﾃｳn de subida de archivos.
 *
 * Se documenta en espaﾃｱol siguiendo las polﾃｭticas del proyecto.
 *
 * Exports:
 *  - CategoryForm::configure(Schema): Schema
 *
 * Dependencies:
 *  - Filament >= 3.0
 *  - Laravel >= 10.0
 *  - Illuminate\Support\Str
 *
 * Author: (aﾃｱade tu nombre si lo deseas)
 * Created: 2025-11-12
 */

<?php

namespace App\Filament\Resources\Categories\Schemas;

use Filament\Forms\Components\FileUpload;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Components\Textarea;
use Filament\Forms\Components\Toggle;
use Filament\Schemas\Components\Section;
use Filament\Schemas\Schema;
use Illuminate\Support\Str;

/**
 * Clase que encapsula la configuraciﾃｳn del formulario de categorﾃｭas.
 *
 * Responsibilities:
 *  - Declarar los campos del formulario (inputs, toggles, uploads)
 *  - Configurar validaciones y comportamientos dinﾃ｡micos
 *  - Organizar campos en secciones para mejor UX
 */
class CategoryForm
{
    /**
     * Configura la instancia de Filament\Schema\Schema usada en las pﾃ｡ginas
     * Create y Edit del recurso Category.
     *
     * Incluye lﾃｳgica para generar automﾃ｡ticamente el slug a partir del nombre,
     * validaciones de unicidad y configuraciﾃｳn de subida de imﾃ｡genes.
     *
     * Args:
     *  - $schema (Schema): instancia de Filament Schema que serﾃ｡ mutada.
     *
     * Returns:
     *  - Schema: la misma instancia configurada y retornada para encadenado.
     *
     * Note:
     *  - Utiliza live updates para interacciones dinﾃ｡micas sin recargar la pﾃ｡gina.
     */
    public static function configure(Schema $schema): Schema
    {
        return $schema
            ->components([
                Section::make('Informaciﾃｳn Bﾃ｡sica')
                    // Divide los campos internos en 2 columnas
                    ->columns(2)
                    ->description('Detalles principales de la categorﾃｭa y su estado.')
                    ->schema([
                        // 1. CAMPO NAME (El disparador)
                        TextInput::make('name')
                            ->label('Nombre')
                            ->required()
                            ->autofocus()
                            // 泅 Clave 1: Escuchar cambios al perder el foco
                            ->live(onBlur: true)
                            // 泅 Clave 2: Ejecutar la lﾃｳgica despuﾃｩs de que el estado cambie
                            ->afterStateUpdated(function (string $operation, $state, TextInput $component) {
                                // Obtiene el componente 'slug' y le establece el valor generado
                                $component
                                    ->getContainer()
                                    ->getComponent('slug')
                                    ->state(Str::slug($state));
                            }),

                        // 2. CAMPO SLUG (El receptor)
                        TextInput::make('slug')
                            ->label('Slug')
                            ->required()
                            ->unique(ignoreRecord: true) // Asegura unicidad en la BD
                            // 泅 Clave 3: Lo hace de solo lectura para el usuario
                            ->readOnly()
                            ->helperText('Se genera automﾃ｡ticamente a partir del nombre.'),

                        // Se muestra en la segunda columna, debajo del slug
                        Toggle::make('is_active')
                            ->label('Activa?') // UX: Texto mﾃ｡s descriptivo que 'Activo'
                            ->inline(false) // Muestra el toggle en una lﾃｭnea separada
                            ->default(true), // BUENA PRﾃ，TICA: Asumir que es activa por defecto

                        // Descripciﾃｳn a ancho completo (debajo de las 2 columnas)
                        Textarea::make('description')
                            ->label('Descripciﾃｳn Detallada')
                            ->columnSpanFull() // Ocupa el ancho completo (1/1)
                            ->maxLength(500) // BUENA PRﾃ，TICA: Limitar la entrada
                            ->rows(4), // UX: Aumentar la altura para mejor escritura
                    ]),

                Section::make('Contenido Multimedia')
                    ->description('Sube la imagen principal de la categorﾃｭa (banners, iconos, etc).')
                    ->schema([
                        FileUpload::make('image')
                            ->label('Imagen Principal')
                            ->image()
                            ->acceptedFileTypes(['image/png', 'image/jpeg', 'image/gif'])
                            ->disk('public') // Asegurar que usa el disco pﾃｺblico
                            ->directory('category-images') // BUENA PRﾃ，TICA: Organizar las subidas
                            ->maxSize(2048) // BUENA PRﾃ，TICA: Limitar tamaﾃｱo (2MB)

                        Select::make('role')
                            ->options(
                                array_combine(
                                    Role::values(),
                                    array_map(fn($value) => __($value), Role::values())
                                )
                            )
                            ->searchable()
                            ->preload()
                            ->default('client')
                            ->required()
                            ->label(__('Role')),

                            ToggleButtons::make('movement_type')
                        ->options(
                            array_combine(
                                CashMovementType::values(),
                                array_map(fn($value) => __($value), CashMovementType::values())
                            )
                        )
                        ->required()
                        ->grouped()
                        ->label(__('Movement Type')),
                    ])
                    ->collapsible(), // UX: Permite al usuario colapsar la secciﾃｳn si es muy larga
            ]);
    }
}
